{% extends "layouts/base.html" %}
{% block title %}Inventario{% endblock %}

{% block content %}
<h1>Sección Inventario</h1>
<p>Bienvenido, {{ usuario }}. Aquí puedes gestionar el inventario.</p>

<div class="card card-body border-0 shadow mb-4">
  <h2 class="h5 mb-4">Descargar Inventario</h2>
  <form method="post">
      <input type="hidden" name="accion" value="descargar_inventario">
      <div class="row g-2 align-items-end">
          <div class="col-md-12">
              <button type="submit" class="btn btn-primary w-100">Descargar Inventario</button>
          </div>
      </div>
  </form>
</div>

<!-- Filtro de búsqueda -->
<div class="mb-3">
  <div class="row g-2">
      <div class="col-md-2">
          <input type="text" id="filtroTodos" placeholder="busqueda" class="form-control">
      </div>
      <div class="col-md-1">
          <button id="btnLimpiarFiltros" class="btn btn-secondary w-100">Limpiar</button>
      </div>
  </div>
</div>

<div class="card card-body border-0 shadow table-wrapper table-responsive">
  <table class="table table-hover">
      <thead>
          <tr>
              <th class="border-gray-200">Referencia</th>
              <th class="border-gray-200">Descripcion</th>						
              <th class="border-gray-200">Cantidad</th>
              <th class="border-gray-200">Precio</th>
              <th class="border-gray-200">Grupo</th>
              <th class="border-gray-200">Código Barras</th>
          </tr>
      </thead>
      <tbody id="tablaInventario">
          {% for id, codigoBarras, descripcion, cantidad, precioVenta, precioVentaCifrado, precioMaxDescuento, grupo in items %}
          <tr>
              <td><span class="fw-bold">{{ codigoBarras }}</span></td>
              <td><span class="fw-normal">{{ descripcion }}</span></td>
              <td><span class="fw-normal">{{ cantidad }}</span></td>   
              <td><span class="fw-bold">$ {{ precioVenta }}</span></td>
              <td><span class="fw-normal">{{ grupo }}</span></td> 
              <td>
                    <button type="button" class="btn btn-primary btn-editar"
                        data-id="{{ id }}"
                        data-codigo="{{ codigoBarras }}"
                        data-descripcion="{{ descripcion }}"
                        data-cantidad="{{ cantidad }}"
                        data-precio="{{ precioVenta }}"
                        data-grupo="{{ grupo }}">
                        ||||
                    </button>
              </td>
          </tr>
          {% endfor %}
      </tbody>
  </table>
</div>

<div class="card-footer px-3 border-0 d-flex flex-column flex-lg-row align-items-center justify-content-between">
  <nav aria-label="Page navigation example">
      <ul class="pagination mb-0" id="pagination"></ul>
  </nav>
  <div class="fw-normal small mt-4 mt-lg-0" id="infoPaginacion"></div>
</div>

<!-- MODAL FLOTANTE PARA EDITAR -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEditarLabel">Editar Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formEditarItem">
          <input type="hidden" id="itemId">
          
          <div class="mb-3">
            <label for="codigoBarrasEdit" class="form-label">Código Barras</label>
            <input type="text" class="form-control" id="codigoBarrasEdit" readonly>
          </div>

          <div class="mb-3">
            <label for="descripcionEdit" class="form-label">Descripción</label>
            <input type="text" class="form-control" id="descripcionEdit">
          </div>

          <div class="mb-3">
            <label for="cantidadEdit" class="form-label">Cantidad</label>
            <input type="number" class="form-control" id="cantidadEdit">
          </div>

          <div class="mb-3">
            <label for="precioEdit" class="form-label">Precio Venta</label>
            <input type="number" class="form-control" id="precioEdit" step="0.01">
          </div>

          <div class="mb-3">
            <label for="grupoEdit" class="form-label">Grupo</label>
            <input type="text" class="form-control" id="grupoEdit">
          </div>

          

          <!-- Sección de impresión -->
          <div id="seccionImpresion" style="display: none;" class="border-top pt-3 mt-3">
                <h6>Impresión</h6>
                <div id="seccionCantidadImprimir" style="display: none;" class="mb-3">
                    <label for="cantidadImprimir" class="form-label">Cantidad a Imprimir</label>
                    <input type="number" class="form-control" id="cantidadImprimir" min="1" value="1">
                </div>

                <div id="seccionColumna" style="display: none;" class="mb-3">
                    <label for="columnaInicio" class="form-label">Columna de Inicio</label>
                    <select id="columnaInicio" class="form-control">
                        <option value="1">Columna 1</option>
                        <option value="2">Columna 2</option>
                    </select>
                </div>
          </div>

          

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-info" id="btnImprimirModal">Imprimir</button>
        <button type="button" class="btn btn-success" id="btnGuardarItem">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>




<script>
document.addEventListener('DOMContentLoaded', function() {
    const todasFilas = Array.from(document.querySelectorAll('#tablaInventario tr'));
    const filasPorPagina = 30;
    let paginaActual = 1;
    let filasVisibles = [...todasFilas];
    let estadoImpresion = {}; // {id: 'esperandoCantidad' o 'listo'}

    // Variables para el modal
    let modalEditar = new bootstrap.Modal(document.getElementById('modalEditar'), {
        backdrop: 'static',
        keyboard: false
    });

    window.abrirModalEditar = function(id, codigo, descripcion, cantidad, precio, grupo) {
        document.getElementById('itemId').value = id;
        document.getElementById('codigoBarrasEdit').value = codigo;
        document.getElementById('descripcionEdit').value = descripcion;
        document.getElementById('cantidadEdit').value = cantidad;
        document.getElementById('precioEdit').value = precio;
        document.getElementById('grupoEdit').value = grupo;
        
        estadoImpresion[id] = 'esperandoCantidad'; // Resetear estado
        document.getElementById('seccionImpresion').style.display = 'none';
        document.getElementById('seccionCantidadImprimir').style.display = 'none';
        document.getElementById('seccionColumna').style.display = 'none';
        document.getElementById('cantidadImprimir').value = 1;
        document.getElementById('columnaInicio').value = '1';
        document.getElementById('btnImprimirModal').textContent = 'Imprimir';
        
        modalEditar.show();
    };

    // GUARDAR CAMBIOS
    document.getElementById('btnGuardarItem').addEventListener('click', async function() {
        const id = document.getElementById('itemId').value;
        const descripcion = document.getElementById('descripcionEdit').value;
        const cantidad = document.getElementById('cantidadEdit').value;
        const precio = document.getElementById('precioEdit').value;
        const grupo = document.getElementById('grupoEdit').value;

        if (!descripcion.trim() || !cantidad || !precio) {
            alert('Por favor completa todos los campos');
            return;
        }

        try {
            const response = await fetch('/inventario/actualizar_item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: id,
                    descripcion: descripcion,
                    cantidad: parseInt(cantidad),
                    precio: parseFloat(precio),
                    grupo: grupo
                })
            });

            const data = await response.json();

            if (data.ok) {
                alert('Item actualizado correctamente ✔️');
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'No se pudo guardar'));
            }
        } catch (error) {
            alert('Error de conexión: ' + error.message);
        }
    });

    // Adjuntar manejador a botones "editar" (evita problemas con comillas en la descripción)
    document.querySelectorAll('.btn-editar').forEach(btn => {
        btn.addEventListener('click', function() {
            const d = btn.dataset;
            abrirModalEditar(d.id, d.codigo, d.descripcion, d.cantidad, d.precio, d.grupo);
        });
    });

    // IMPRESIÓN CON DOS PASOS
    document.getElementById('btnImprimirModal').addEventListener('click', async function() {
        const id = document.getElementById('itemId').value;
        const estado = estadoImpresion[id];

        if (estado === 'esperandoCantidad') {
            // Primer click: mostrar sección de impresión, cantidad y columna
            document.getElementById('seccionImpresion').style.display = 'block';
            document.getElementById('seccionCantidadImprimir').style.display = 'block';
            document.getElementById('seccionColumna').style.display = 'block';
            document.getElementById('cantidadImprimir').focus();
            document.getElementById('btnImprimirModal').textContent = 'Ejecutar Impresión';
            estadoImpresion[id] = 'listo';
        } else if (estado === 'listo') {
            // Segundo click: imprimir
            const codigo = document.getElementById('codigoBarrasEdit').value;
            const descripcion = document.getElementById('descripcionEdit').value;
            const precio = document.getElementById('precioEdit').value;
            const cantidad = parseInt(document.getElementById('cantidadImprimir').value);

            if (!cantidad || cantidad < 1) {
                alert('Ingresa una cantidad válida');
                return;
            }

            try {
                const columnaInicio = parseInt(document.getElementById('columnaInicio').value);
                const response = await fetch('/inventario/imprimir_etiqueta_nueva', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codigo: codigo,
                        descripcion: descripcion,
                        precio: precio,
                        cantidad: cantidad,
                        columna_inicio: columnaInicio
                    })
                });

                const data = await response.json();

                if (data.ok) {
                    alert(`Imprimiendo ${cantidad} etiqueta(s)... ✔️`);
                    document.getElementById('seccionCantidadImprimir').style.display = 'none';
                    document.getElementById('btnImprimirModal').textContent = 'Imprimir';
                    estadoImpresion[id] = 'esperandoCantidad';
                } else {
                    alert('Error: ' + (data.error || 'No se pudo imprimir'));
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        }
    });

    function mostrarPagina(pagina) {
        const inicio = (pagina - 1) * filasPorPagina;
        const fin = inicio + filasPorPagina;

        todasFilas.forEach(fila => fila.style.display = 'none');
        filasVisibles.slice(inicio, fin).forEach(fila => fila.style.display = '');

        paginaActual = pagina;
        renderPaginacion();
    }

    function renderPaginacion() {
        const totalPaginas = Math.ceil(filasVisibles.length / filasPorPagina);
        const paginacion = document.getElementById('pagination');
        const info = document.getElementById('infoPaginacion');

        if (totalPaginas === 0) {
            paginacion.innerHTML = '';
            info.innerHTML = 'No hay coincidencias';
            return;
        }

        let html = `
            <li class="page-item ${paginaActual === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#">Anterior</a>
            </li>
        `;

        const rango = 2;
        const mostrarEllipsis = totalPaginas > 7;

        for (let i = 1; i <= totalPaginas; i++) {
            if (i === 1 || i === totalPaginas || (i >= paginaActual - rango && i <= paginaActual + rango)) {
                html += `
                    <li class="page-item ${paginaActual === i ? 'active' : ''}">
                        <a class="page-link" href="#">${i}</a>
                    </li>
                `;
            } else if (mostrarEllipsis && (i === 2 && paginaActual > rango + 2)) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            } else if (mostrarEllipsis && (i === totalPaginas - 1 && paginaActual < totalPaginas - (rango + 1))) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        html += `
            <li class="page-item ${paginaActual === totalPaginas ? 'disabled' : ''}">
                <a class="page-link" href="#">Siguiente</a>
            </li>
        `;

        paginacion.innerHTML = html;
        info.innerHTML = `Página ${paginaActual} de ${totalPaginas} (${filasVisibles.length} registros)`;

        document.querySelectorAll('#pagination .page-link').forEach((btn) => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                if (btn.textContent === 'Anterior' && paginaActual > 1) mostrarPagina(paginaActual - 1);
                else if (btn.textContent === 'Siguiente' && paginaActual < totalPaginas) mostrarPagina(paginaActual + 1);
                else if (!isNaN(parseInt(btn.textContent))) mostrarPagina(parseInt(btn.textContent));
            });
        });
    }

    function filtrar() {
        const textoFiltro = document.getElementById('filtroTodos').value.toLowerCase().trim();
        const palabras = textoFiltro.split(/\s+/).filter(p => p);
        filasVisibles = todasFilas.filter(fila => {
            const contenidoFila = Array.from(fila.querySelectorAll('td'))
                .map(td => td.textContent.toLowerCase())
                .join(' ');
            return palabras.every(palabra => contenidoFila.includes(palabra));
        });
        mostrarPagina(1);
    }

    document.getElementById('filtroTodos').addEventListener('input', filtrar);
    document.getElementById('btnLimpiarFiltros').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('filtroTodos').value = '';
        filasVisibles = [...todasFilas];
        mostrarPagina(1);
    });

    mostrarPagina(1);
});
</script>


{% endblock %}
