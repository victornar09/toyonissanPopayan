{% extends "layouts/base.html" %}
{% block title %}Inventario{% endblock %}

{% block content %}
<h1>Sección Inventario</h1>
<p>Bienvenido, {{ usuario }}. Aquí puedes gestionar el inventario.</p>

<div class="card card-body border-0 shadow mb-4">
  <h2 class="h5 mb-4">Descargar Inventario</h2>
  <form method="post">
      <input type="hidden" name="accion" value="descargar_inventario">
      <div class="row g-2 align-items-end">
          <div class="col-md-12">
              <button type="submit" class="btn btn-primary w-100">Descargar Inventario</button>
          </div>
      </div>
  </form>
</div>

<!-- Filtro de búsqueda -->
<div class="mb-3">
  <div class="row g-2">
      <div class="col-md-2">
          <input type="text" id="filtroTodos" placeholder="busqueda" class="form-control">
      </div>
      <div class="col-md-1">
          <button id="btnLimpiarFiltros" class="btn btn-secondary w-100">Limpiar</button>
      </div>
  </div>
</div>

<div class="card card-body border-0 shadow table-wrapper table-responsive">
  <table class="table table-hover">
      <thead>
          <tr>
              <th class="border-gray-200">Referencia</th>
              <th class="border-gray-200">Descripcion</th>						
              <th class="border-gray-200">Cantidad</th>
              <th class="border-gray-200">Precio</th>
              <th class="border-gray-200">Grupo</th>
              <th class="border-gray-200">Código Barras</th>
          </tr>
      </thead>
      <tbody id="tablaInventario">
          {% for codigoBarras, descripcion, cantidad, precioVenta, grupo in items %}
          <tr>
              <td><span class="fw-bold">{{ codigoBarras }}</span></td>
              <td><span class="fw-normal">{{ descripcion }}</span></td>
              <td><span class="fw-normal">{{ cantidad }}</span></td>   
              <td><span class="fw-bold">$ {{ precioVenta }}</span></td>
              <td><span class="fw-normal">{{ grupo }}</span></td> 
              <td>
                    <button class="btn btn-success" onclick="imprimirBT('{{ row.codigo }}', '{{ row.descripcion }}', '{{ row.precio }}')">
                        Imprimir
                    </button>
              </td>
          </tr>
          {% endfor %}
      </tbody>
  </table>
</div>

<div class="card-footer px-3 border-0 d-flex flex-column flex-lg-row align-items-center justify-content-between">
  <nav aria-label="Page navigation example">
      <ul class="pagination mb-0" id="pagination"></ul>
  </nav>
  <div class="fw-normal small mt-4 mt-lg-0" id="infoPaginacion"></div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const todasFilas = Array.from(document.querySelectorAll('#tablaInventario tr'));
    const filasPorPagina = 30;
    let paginaActual = 1;
    let filasVisibles = [...todasFilas];

    window.imprimirBT = async function(codigo, descripcion, precio) {
        const cantidad = 1;        // Puedes abrir un prompt si quieres: prompt("Cantidad?")
        const columna = 1;         // Igual podrías preguntar: prompt("Columna 1 o 2?")

        const payload = {
            codigo: codigo,
            descripcion: descripcion,
            precio: precio,
            cantidad: cantidad,
            columna_inicio: columna
        };

        const res = await fetch("/inventario/imprimir_etiqueta", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.ok) {
            alert("Etiqueta enviada a impresión ✔️");
        } else {
            alert("Error: " + data.error);
        }
    }

    function mostrarPagina(pagina) {
        const inicio = (pagina - 1) * filasPorPagina;
        const fin = inicio + filasPorPagina;

        todasFilas.forEach(fila => fila.style.display = 'none');
        filasVisibles.slice(inicio, fin).forEach(fila => fila.style.display = '');

        paginaActual = pagina;
        renderPaginacion();
    }

    function renderPaginacion() {
        const totalPaginas = Math.ceil(filasVisibles.length / filasPorPagina);
        const paginacion = document.getElementById('pagination');
        const info = document.getElementById('infoPaginacion');

        if (totalPaginas === 0) {
            paginacion.innerHTML = '';
            info.innerHTML = 'No hay coincidencias';
            return;
        }

        let html = `
            <li class="page-item ${paginaActual === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#">Anterior</a>
            </li>
        `;

        const rango = 2;
        const mostrarEllipsis = totalPaginas > 7;

        for (let i = 1; i <= totalPaginas; i++) {
            if (i === 1 || i === totalPaginas || (i >= paginaActual - rango && i <= paginaActual + rango)) {
                html += `
                    <li class="page-item ${paginaActual === i ? 'active' : ''}">
                        <a class="page-link" href="#">${i}</a>
                    </li>
                `;
            } else if (mostrarEllipsis && (i === 2 && paginaActual > rango + 2)) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            } else if (mostrarEllipsis && (i === totalPaginas - 1 && paginaActual < totalPaginas - (rango + 1))) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        html += `
            <li class="page-item ${paginaActual === totalPaginas ? 'disabled' : ''}">
                <a class="page-link" href="#">Siguiente</a>
            </li>
        `;

        paginacion.innerHTML = html;
        info.innerHTML = `Página ${paginaActual} de ${totalPaginas} (${filasVisibles.length} registros)`;

        document.querySelectorAll('#pagination .page-link').forEach((btn) => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                if (btn.textContent === 'Anterior' && paginaActual > 1) mostrarPagina(paginaActual - 1);
                else if (btn.textContent === 'Siguiente' && paginaActual < totalPaginas) mostrarPagina(paginaActual + 1);
                else if (!isNaN(parseInt(btn.textContent))) mostrarPagina(parseInt(btn.textContent));
            });
        });
    }

    function filtrar() {
        const textoFiltro = document.getElementById('filtroTodos').value.toLowerCase().trim();
        const palabras = textoFiltro.split(/\s+/).filter(p => p);
        filasVisibles = todasFilas.filter(fila => {
            const contenidoFila = Array.from(fila.querySelectorAll('td'))
                .map(td => td.textContent.toLowerCase())
                .join(' ');
            return palabras.every(palabra => contenidoFila.includes(palabra));
        });
        mostrarPagina(1);
    }

    document.getElementById('filtroTodos').addEventListener('input', filtrar);
    document.getElementById('btnLimpiarFiltros').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('filtroTodos').value = '';
        filasVisibles = [...todasFilas];
        mostrarPagina(1);
    });

    mostrarPagina(1);
});
</script>


{% endblock %}
